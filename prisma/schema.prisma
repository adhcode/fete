generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum PhotoStatus {
  PENDING_UPLOAD
  UPLOADED
  PROCESSED
  FAILED
}

model Organizer {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String // hashed
  name      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  events Event[]
}

model Template {
  id         String   @id @default(cuid())
  name       String
  previewUrl String? // Public URL to preview image
  overlayKey String? // R2 key for overlay PNG
  config     Json    // Template configuration (text fields, overlay settings)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  events Event[]

  @@index([createdAt])
}

model Event {
  id    String    @id @default(cuid())
  code  String    @unique // short share code e.g. ABCD12
  name  String
  date  DateTime?
  venue String?

  // Event-level defaults
  shareCaptionDefault String? // e.g. "LKJ Iftar 2026 ðŸ”¥"
  hashtag             String? // optional

  // Toggle behavior per event
  approvalRequired Boolean @default(false)
  publicGallery    Boolean @default(false)
  allowShareLinks  Boolean @default(true)

  // Rate limits / caps (optional)
  maxUploadsPerGuest Int? // e.g. 20
  maxUploadsTotal    Int? // e.g. 500

  templateId String?
  template   Template? @relation(fields: [templateId], references: [id])

  organizerId String
  organizer   Organizer @relation(fields: [organizerId], references: [id])

  photos       Photo[]
  exports      Export[]
  shareBundles ShareBundle[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizerId, createdAt])
}

model Photo {
  id      String @id @default(cuid())
  eventId String
  event   Event  @relation(fields: [eventId], references: [id], onDelete: Cascade)

  status   PhotoStatus @default(PENDING_UPLOAD)
  approved Boolean     @default(true)

  // Guest-provided caption for sharing (optional)
  caption String?

  // Storage keys in R2 (never store full signed URLs here)
  originalKey String?
  largeKey    String?
  thumbKey    String?

  width  Int?
  height Int?

  // For abuse control (hash of device fingerprint, or random guestId stored in localStorage)
  uploaderHash String?

  // Public sharing
  shareSlug String? @unique // e.g. "p_x8K2d1" (optional)
  isPublic  Boolean @default(false)

  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  shareBundleItems ShareBundleItem[]

  @@index([eventId, createdAt])
  @@index([eventId, approved, createdAt])
  @@index([status])
}

model ShareBundle {
  id      String @id @default(cuid())
  slug    String @unique // e.g. "s_Ab12Cd"
  eventId String
  event   Event  @relation(fields: [eventId], references: [id], onDelete: Cascade)

  caption String? // optional caption for the bundle share

  items ShareBundleItem[]

  createdAt DateTime  @default(now())
  expiresAt DateTime?

  @@index([eventId, createdAt])
}

model ShareBundleItem {
  id       String      @id @default(cuid())
  bundleId String
  bundle   ShareBundle @relation(fields: [bundleId], references: [id], onDelete: Cascade)

  photoId String
  photo   Photo  @relation(fields: [photoId], references: [id], onDelete: Cascade)

  sortOrder Int @default(0)

  @@unique([bundleId, photoId])
  @@index([photoId])
}

model Export {
  id      String @id @default(cuid())
  eventId String
  event   Event  @relation(fields: [eventId], references: [id], onDelete: Cascade)

  zipKey    String
  createdAt DateTime @default(now())

  @@index([eventId, createdAt])
}
